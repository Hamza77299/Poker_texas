<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Online Poker</title>
    <style>
        /* All the previous CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d3b2a, #1a5c3c);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ffcc00;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .setup-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .player-setup {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .player-setup input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }

        .setup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-create {
            background: linear-gradient(135deg, #2196f3, #1565c0);
            color: white;
        }

        .btn-join {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .btn-start {
            background: linear-gradient(135deg, #ff9800, #ef6c00);
            color: white;
        }

        .btn-leave {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }

        .btn-bet {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .btn-fold {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }

        .btn-check {
            background: linear-gradient(135deg, #2196f3, #1565c0);
            color: white;
        }

        .btn-call {
            background: linear-gradient(135deg, #ff9800, #ef6c00);
            color: white;
        }

        .btn-raise {
            background: linear-gradient(135deg, #9c27b0, #6a1b9a);
            color: white;
        }

        .lobby {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .player-info, .pot-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-name, .pot-label {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .player-chips, .pot-amount {
            font-size: 1.5rem;
            color: #ffcc00;
        }

        .table-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .players-around-table {
            display: flex;
            justify-content: space-around;
            width: 100%;
            flex-wrap: wrap;
            gap: 20px;
        }

        .player-seat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            min-width: 150px;
        }

        .player-seat.active {
            border: 2px solid #ffcc00;
        }

        .player-seat.current-turn {
            border: 2px solid #4caf50;
        }

        .player-seat.dealer {
            position: relative;
        }

        .dealer-button {
            position: absolute;
            top: -10px;
            width: 25px;
            height: 25px;
            background: #ffcc00;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #000;
        }

        .player-cards {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .community-cards {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .community-label {
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #aaa;
        }

        .cards-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card {
            width: 80px;
            height: 112px;
            background: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-back {
            background: linear-gradient(45deg, #d32f2f, #b71c1c);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .card-top, .card-bottom {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .card-bottom {
            align-items: flex-end;
            transform: rotate(180deg);
        }

        .card-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .card-suit {
            font-size: 1rem;
        }

        .hearts, .diamonds {
            color: #e53935;
        }

        .clubs, .spades {
            color: #000;
        }

        .player-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .betting-controls {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
        }

        .slider-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        input[type="range"] {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffcc00;
            cursor: pointer;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            height: 150px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hand-result {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 204, 0, 0.1);
            color: #ffcc00;
        }

        .game-phase {
            text-align: center;
            font-size: 1.2rem;
            margin: 10px 0;
            color: #ffcc00;
        }

        .chat-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 200px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .invite-section {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .invite-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .invite-controls input {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
        }

        .status-indicator.connected {
            background: #4caf50;
        }

        @media (max-width: 768px) {
            .card {
                width: 60px;
                height: 84px;
            }
            
            .card-value {
                font-size: 1rem;
            }
            
            .card-suit {
                font-size: 0.8rem;
            }
            
            .player-actions {
                gap: 10px;
            }
            
            button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .players-around-table {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Firebase Online Poker</h1>
            <p>Play Texas Hold'em with friends in real-time</p>
        </header>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setup-screen">
            <div class="player-setup">
                <h2>Join the Game</h2>
                <input type="text" id="player-name-input" placeholder="Enter your name" maxlength="20">
                <input type="text" id="game-id-input" placeholder="Enter Game ID (for joining)">
                
                <div class="setup-buttons">
                    <button class="btn-create" id="create-game-btn">Create New Game</button>
                    <button class="btn-join" id="join-game-btn">Join Game</button>
                </div>
                
                <div class="connection-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="status-text">Disconnected</span>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div class="lobby" id="lobby">
            <div class="game-info">
                <div class="player-info">
                    <div class="player-name" id="player-name-display">Player</div>
                    <div class="player-chips">$<span id="player-chips">1000</span></div>
                </div>
                <div class="pot-info">
                    <div class="pot-label">Pot</div>
                    <div class="pot-amount">$<span id="pot-amount">0</span></div>
                </div>
            </div>

            <div class="game-phase" id="game-phase">Waiting for players...</div>

            <div class="table-view">
                <div class="players-around-table" id="players-around-table">
                    <!-- Players will be dynamically added here -->
                </div>

                <div class="community-cards">
                    <div class="community-label">Community Cards</div>
                    <div class="cards-container" id="community-cards">
                        <!-- Community cards will be generated here -->
                    </div>
                </div>

                <div class="player-actions">
                    <button class="btn-check" id="check-btn">Check</button>
                    <button class="btn-call" id="call-btn">Call $0</button>
                    <button class="btn-bet" id="bet-btn">Bet</button>
                    <button class="btn-raise" id="raise-btn">Raise</button>
                    <button class="btn-fold" id="fold-btn">Fold</button>
                    <button class="btn-start" id="start-game-btn" style="display: none;">Start Game</button>
                </div>

                <div class="betting-controls" id="betting-controls">
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Bet Amount:</span>
                            <span id="bet-amount">50</span>
                        </div>
                        <input type="range" id="bet-slider" min="10" max="500" value="50" step="10">
                    </div>
                    <button class="btn-bet" id="confirm-bet">Confirm Bet</button>
                </div>
            </div>

            <div class="hand-result" id="hand-result"></div>

            <div class="game-log">
                <h3>Game Log</h3>
                <div id="log-entries">
                    <div class="log-entry">Welcome to Firebase Poker! Create or join a game to start playing.</div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="log-entry">System: Welcome to the table!</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button class="btn-bet" id="send-chat-btn">Send</button>
                </div>
            </div>

            <div class="invite-section">
                <h3>Invite Friends</h3>
                <p>Share this Game ID with friends:</p>
                <div class="invite-controls">
                    <input type="text" id="invite-game-id" readonly>
                    <button class="btn-bet" id="copy-invite-btn">Copy ID</button>
                </div>
            </div>

            <div class="player-actions" style="justify-content: center; margin-top: 20px;">
                <button class="btn-leave" id="leave-game-btn">Leave Game</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyAesRzQwdqscBYjPk3r2ZVQZdzvxa3eG48",
  authDomain: "poker-32c77.firebaseapp.com",
  databaseURL: "https://poker-32c77-default-rtdb.firebaseio.com",
  projectId: "poker-32c77",
  storageBucket: "poker-32c77.firebasestorage.app",
  messagingSenderId: "138622819225",
  appId: "1:138622819225:web:a0a1273b61572d4419d108",
  measurementId: "G-6BK95P2QJD"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state
        const gameState = {
            playerId: null,
            playerName: '',
            gameId: null,
            isHost: false,
            playerChips: 1000,
            currentBet: 0,
            playerBet: 0
        };

        // DOM elements
        const setupScreen = document.getElementById('setup-screen');
        const lobby = document.getElementById('lobby');
        const playerNameInput = document.getElementById('player-name-input');
        const gameIdInput = document.getElementById('game-id-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerChipsEl = document.getElementById('player-chips');
        const potAmountEl = document.getElementById('pot-amount');
        const playersAroundTableEl = document.getElementById('players-around-table');
        const communityCardsEl = document.getElementById('community-cards');
        const checkBtn = document.getElementById('check-btn');
        const callBtn = document.getElementById('call-btn');
        const betBtn = document.getElementById('bet-btn');
        const raiseBtn = document.getElementById('raise-btn');
        const foldBtn = document.getElementById('fold-btn');
        const bettingControls = document.getElementById('betting-controls');
        const betSlider = document.getElementById('bet-slider');
        const betAmountEl = document.getElementById('bet-amount');
        const confirmBetBtn = document.getElementById('confirm-bet');
        const handResultEl = document.getElementById('hand-result');
        const logEntriesEl = document.getElementById('log-entries');
        const gamePhaseEl = document.getElementById('game-phase');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInputEl = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const inviteGameIdEl = document.getElementById('invite-game-id');
        const copyInviteBtn = document.getElementById('copy-invite-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        // Initialize game
        function initGame() {
            // Generate player ID
            gameState.playerId = generateId();
            
            // Load saved name if exists
            const savedName = localStorage.getItem('pokerPlayerName');
            if (savedName) {
                playerNameInput.value = savedName;
            }
            
            // Event listeners
            createGameBtn.addEventListener('click', createGame);
            joinGameBtn.addEventListener('click', joinGame);
            leaveGameBtn.addEventListener('click', leaveGame);
            startGameBtn.addEventListener('click', startGame);
            checkBtn.addEventListener('click', () => sendPlayerAction('check'));
            callBtn.addEventListener('click', () => sendPlayerAction('call'));
            betBtn.addEventListener('click', showBettingControls);
            raiseBtn.addEventListener('click', showBettingControls);
            foldBtn.addEventListener('click', () => sendPlayerAction('fold'));
            confirmBetBtn.addEventListener('click', confirmBet);
            betSlider.addEventListener('input', updateBetAmount);
            sendChatBtn.addEventListener('click', sendChatMessage);
            chatInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            copyInviteBtn.addEventListener('click', copyGameId);
            
            updateConnectionStatus(false, 'Disconnected');
            addLogEntry("Enter your name and create or join a game.");
            
            // Disable actions initially
            disablePlayerActions();
        }

        // Generate unique ID
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        // Update connection status
        function updateConnectionStatus(connected, message) {
            statusIndicator.className = 'status-indicator ' + (connected ? 'connected' : '');
            statusText.textContent = message;
        }

        // Create new game
        function createGame() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            gameState.playerName = playerName;
            gameState.gameId = generateId();
            gameState.isHost = true;
            
            // Save name to localStorage
            localStorage.setItem('pokerPlayerName', playerName);
            
            const gameData = {
                host: gameState.playerId,
                players: {
                    [gameState.playerId]: {
                        name: playerName,
                        chips: 1000,
                        ready: true,
                        folded: false,
                        currentBet: 0,
                        hasActed: false
                    }
                },
                status: 'waiting',
                gameState: {
                    phase: 'waiting',
                    communityCards: [],
                    pot: 0,
                    currentBet: 0,
                    dealerPosition: 0,
                    currentPlayer: null,
                    smallBlind: 10,
                    bigBlind: 20,
                    deck: [],
                    bettingRound: 'preflop'
                },
                created: Date.now()
            };

            // Write to Firebase
            database.ref('games/' + gameState.gameId).set(gameData)
                .then(() => {
                    updateConnectionStatus(true, 'Game created!');
                    switchToLobby();
                    setupGameListeners();
                    addLogEntry(`Game created! Share Game ID: ${gameState.gameId}`);
                })
                .catch(error => {
                    console.error('Error creating game:', error);
                    alert('Error creating game. Please try again.');
                });
        }

        // Join existing game
        function joinGame() {
            const playerName = playerNameInput.value.trim();
            const gameId = gameIdInput.value.trim();
            
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            if (!gameId) {
                alert('Please enter a Game ID');
                return;
            }

            gameState.playerName = playerName;
            gameState.gameId = gameId;
            gameState.isHost = false;
            
            // Save name to localStorage
            localStorage.setItem('pokerPlayerName', playerName);
            
            // Check if game exists and join
            database.ref('games/' + gameId).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const gameData = snapshot.val();
                        
                        // Add player to game
                        return database.ref('games/' + gameId + '/players/' + gameState.playerId).set({
                            name: playerName,
                            chips: 1000,
                            ready: false,
                            folded: false,
                            currentBet: 0,
                            hasActed: false
                        });
                    } else {
                        throw new Error('Game not found');
                    }
                })
                .then(() => {
                    updateConnectionStatus(true, 'Joined game!');
                    switchToLobby();
                    setupGameListeners();
                    addLogEntry(`Joined game ${gameId}`);
                })
                .catch(error => {
                    console.error('Error joining game:', error);
                    alert('Error joining game. Please check the Game ID.');
                });
        }

        // Leave game
        function leaveGame() {
            if (gameState.gameId) {
                // Remove player from game
                database.ref('games/' + gameState.gameId + '/players/' + gameState.playerId).remove()
                    .then(() => {
                        // If host and no players left, delete game
                        if (gameState.isHost) {
                            database.ref('games/' + gameState.gameId + '/players').once('value')
                                .then(snapshot => {
                                    if (!snapshot.exists() || snapshot.numChildren() === 0) {
                                        database.ref('games/' + gameState.gameId).remove();
                                    }
                                });
                        }
                        
                        resetGame();
                        switchToSetup();
                        updateConnectionStatus(false, 'Disconnected');
                        addLogEntry("Left the game");
                    });
            }
        }

        // Start the game
        function startGame() {
            if (gameState.isHost) {
                // Create and shuffle deck
                const deck = createDeck();
                shuffleDeck(deck);
                
                // Deal cards to players and start first hand
                startNewHand(deck);
            }
        }

        // Create a deck of cards
        function createDeck() {
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const deck = [];
            
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ suit, value });
                }
            }
            return deck;
        }

        // Shuffle deck using Fisher-Yates algorithm
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Start new hand
        function startNewHand(deck) {
            if (!gameState.isHost) return;
            
            // Get current players
            database.ref('games/' + gameState.gameId + '/players').once('value')
                .then(snapshot => {
                    const players = snapshot.val();
                    const playerIds = Object.keys(players);
                    
                    if (playerIds.length < 2) {
                        alert('Need at least 2 players to start the game');
                        return;
                    }

                    // Deal cards to players
                    const playerCards = {};
                    playerIds.forEach((playerId, index) => {
                        playerCards[playerId] = [
                            deck[index * 2],
                            deck[index * 2 + 1]
                        ];
                    });

                    // Set blinds and first player
                    const smallBlindPos = 0;
                    const bigBlindPos = 1 % playerIds.length;
                    const firstPlayerPos = 2 % playerIds.length;

                    // Update game state
                    const gameStateUpdate = {
                        status: 'playing',
                        gameState: {
                            phase: 'preflop',
                            communityCards: [],
                            pot: 30, // Small + big blind
                            currentBet: 20, // Big blind amount
                            dealerPosition: 0,
                            currentPlayer: playerIds[firstPlayerPos],
                            smallBlind: 10,
                            bigBlind: 20,
                            deck: deck.slice(playerIds.length * 2), // Remove dealt cards
                            bettingRound: 'preflop',
                            playerCards: playerCards
                        }
                    };

                    // Update player bets for blinds
                    const playerUpdates = {};
                    playerUpdates[playerIds[smallBlindPos] + '/currentBet'] = 10;
                    playerUpdates[playerIds[smallBlindPos] + '/chips'] = players[playerIds[smallBlindPos]].chips - 10;
                    playerUpdates[playerIds[bigBlindPos] + '/currentBet'] = 20;
                    playerUpdates[playerIds[bigBlindPos] + '/chips'] = players[playerIds[bigBlindPos]].chips - 20;

                    // Reset all players' acted status
                    playerIds.forEach(playerId => {
                        playerUpdates[playerId + '/hasActed'] = false;
                        playerUpdates[playerId + '/folded'] = false;
                    });

                    // Apply all updates
                    return Promise.all([
                        database.ref('games/' + gameState.gameId).update(gameStateUpdate),
                        database.ref('games/' + gameState.gameId + '/players').update(playerUpdates)
                    ]);
                })
                .then(() => {
                    addLogEntry("New hand started! Blinds posted.");
                })
                .catch(error => {
                    console.error('Error starting new hand:', error);
                });
        }

        // Switch to lobby view
        function switchToLobby() {
            setupScreen.style.display = 'none';
            lobby.style.display = 'flex';
            playerNameDisplay.textContent = gameState.playerName;
            inviteGameIdEl.value = gameState.gameId;
            
            if (gameState.isHost) {
                startGameBtn.style.display = 'block';
            }
        }

        // Switch to setup view
        function switchToSetup() {
            lobby.style.display = 'none';
            setupScreen.style.display = 'block';
            gameState.gameId = null;
            gameState.isHost = false;
        }

        // Set up Firebase listeners
        function setupGameListeners() {
            // Listen for game changes
            database.ref('games/' + gameState.gameId).on('value', snapshot => {
                const gameData = snapshot.val();
                if (gameData) {
                    updateGameUI(gameData);
                }
            });

            // Listen for actions
            database.ref('games/' + gameState.gameId + '/actions').on('child_added', snapshot => {
                const action = snapshot.val();
                if (action.playerId !== gameState.playerId && gameState.isHost) {
                    processPlayerAction(action);
                }
            });

            // Listen for chat messages
            database.ref('games/' + gameState.gameId + '/chat').on('child_added', snapshot => {
                const message = snapshot.val();
                addChatMessage(message.playerName, message.text, message.timestamp);
            });
        }

        // Update game UI based on Firebase data
        function updateGameUI(gameData) {
            // Update players list
            updatePlayersList(gameData.players);
            
            // Update game state
            if (gameData.gameState) {
                updateGameState(gameData.gameState, gameData.players);
            }
            
            // Update game status
            if (gameData.status === 'playing') {
                startGameBtn.style.display = 'none';
            }
        }

        // Update players list
        function updatePlayersList(players) {
            playersAroundTableEl.innerHTML = '';
            
            if (players) {
                Object.entries(players).forEach(([playerId, player], index) => {
                    const playerSeat = document.createElement('div');
                    playerSeat.className = 'player-seat';
                    
                    if (playerId === gameState.playerId) {
                        playerSeat.classList.add('active');
                    }
                    
                    // Show current turn
                    const gameStateRef = database.ref('games/' + gameState.gameId + '/gameState/currentPlayer');
                    gameStateRef.once('value').then(snapshot => {
                        if (snapshot.val() === playerId) {
                            playerSeat.classList.add('current-turn');
                        }
                    });

                    // Show dealer button for first player
                    if (index === 0) {
                        playerSeat.classList.add('dealer');
                        playerSeat.innerHTML += '<div class="dealer-button">D</div>';
                    }
                    
                    // Show cards only for current player or at showdown
                    let cardsHTML = '<div class="card card-back">?</div><div class="card card-back">?</div>';
                    if (playerId === gameState.playerId) {
                        // Get player's cards from game state
                        database.ref('games/' + gameState.gameId + '/gameState/playerCards/' + playerId).once('value')
                            .then(snapshot => {
                                const cards = snapshot.val();
                                if (cards && cards.length === 2) {
                                    const card1 = createCardHTML(cards[0]);
                                    const card2 = createCardHTML(cards[1]);
                                    document.getElementById('player-cards-' + playerId).innerHTML = card1 + card2;
                                }
                            });
                    }
                    
                    playerSeat.innerHTML += `
                        <div class="player-name">${player.name} ${playerId === gameState.playerId ? '(You)' : ''}</div>
                        <div class="player-chips">$${player.chips}</div>
                        <div class="player-cards" id="player-cards-${playerId}">
                            ${cardsHTML}
                        </div>
                        <div class="player-bet">Bet: $${player.currentBet || 0}</div>
                        ${player.folded ? '<div style="color: #f44336;">FOLDED</div>' : ''}
                    `;
                    
                    playersAroundTableEl.appendChild(playerSeat);
                });
            }
        }

        // Create card HTML
        function createCardHTML(card) {
            if (!card) return '<div class="card card-back">?</div>';
            
            const suitSymbol = getSuitSymbol(card.suit);
            return `
                <div class="card">
                    <div class="card-top">
                        <div class="card-value">${card.value}</div>
                        <div class="card-suit ${card.suit}">${suitSymbol}</div>
                    </div>
                    <div class="card-bottom">
                        <div class="card-value">${card.value}</div>
                        <div class="card-suit ${card.suit}">${suitSymbol}</div>
                    </div>
                </div>
            `;
        }

        // Update game state
        function updateGameState(gameStateData, players) {
            potAmountEl.textContent = gameStateData.pot || 0;
            gamePhaseEl.textContent = (gameStateData.bettingRound || 'waiting').toUpperCase();
            
            // Update community cards
            if (gameStateData.communityCards) {
                displayCommunityCards(gameStateData.communityCards);
            }
            
            // Update current bet display
            const currentPlayerBet = players && players[gameState.playerId] ? players[gameState.playerId].currentBet || 0 : 0;
            const callAmount = (gameStateData.currentBet || 0) - currentPlayerBet;
            callBtn.textContent = `Call $${callAmount > 0 ? callAmount : 0}`;
            
            // Update player chips
            if (players && players[gameState.playerId]) {
                playerChipsEl.textContent = players[gameState.playerId].chips || 1000;
            }
            
            // Enable/disable actions based on turn
            if (gameStateData.currentPlayer === gameState.playerId && gameStateData.status === 'playing') {
                addLogEntry("Your turn to act");
                enablePlayerActions();
            } else {
                disablePlayerActions();
            }
        }

        // Display community cards
        function displayCommunityCards(cards) {
            communityCardsEl.innerHTML = '';
            
            if (cards && cards.length > 0) {
                cards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card';
                    
                    const suitSymbol = getSuitSymbol(card.suit);
                    cardEl.innerHTML = `
                        <div class="card-top">
                            <div class="card-value">${card.value}</div>
                            <div class="card-suit ${card.suit}">${suitSymbol}</div>
                        </div>
                        <div class="card-bottom">
                            <div class="card-value">${card.value}</div>
                            <div class="card-suit ${card.suit}">${suitSymbol}</div>
                        </div>
                    `;
                    
                    communityCardsEl.appendChild(cardEl);
                });
            }
            
            // Add placeholders for remaining cards
            const cardCount = cards ? cards.length : 0;
            const remainingCards = 5 - cardCount;
            for (let i = 0; i < remainingCards; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'card';
                placeholder.style.background = 'rgba(255, 255, 255, 0.1)';
                placeholder.style.border = '2px dashed rgba(255, 255, 255, 0.3)';
                communityCardsEl.appendChild(placeholder);
            }
        }

        // Get suit symbol
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'hearts': return '♥';
                case 'diamonds': return '♦';
                case 'clubs': return '♣';
                case 'spades': return '♠';
                default: return '';
            }
        }

        // Send player action to Firebase
        function sendPlayerAction(action, betAmount = 0) {
            if (!gameState.gameId) return;
            
            const actionData = {
                playerId: gameState.playerId,
                action: action,
                betAmount: betAmount,
                timestamp: Date.now()
            };
            
            database.ref('games/' + gameState.gameId + '/actions').push(actionData)
                .then(() => {
                    addLogEntry(`You ${action}${betAmount > 0 ? ' $' + betAmount : ''}`);
                    bettingControls.style.display = 'none';
                    disablePlayerActions(); // Disable until next turn
                })
                .catch(error => {
                    console.error('Error sending action:', error);
                });
        }

        // Process player action (host only)
        function processPlayerAction(action) {
            if (!gameState.isHost) return;
            
            const { playerId, action: actionType, betAmount } = action;
            
            // Get current game state
            database.ref('games/' + gameState.gameId).once('value')
                .then(snapshot => {
                    const gameData = snapshot.val();
                    const players = gameData.players;
                    const gameStateData = gameData.gameState;
                    
                    if (gameStateData.currentPlayer !== playerId) {
                        console.log(`Not ${playerId}'s turn`);
                        return;
                    }
                    
                    let updates = {};
                    
                    switch(actionType) {
                        case 'fold':
                            updates[`players/${playerId}/folded`] = true;
                            addLogEntry(`${players[playerId].name} folds`);
                            break;
                            
                        case 'check':
                            // Can only check if no bet to call
                            if (gameStateData.currentBet === (players[playerId].currentBet || 0)) {
                                addLogEntry(`${players[playerId].name} checks`);
                            } else {
                                console.log("Cannot check when there's a bet");
                                return;
                            }
                            break;
                            
                        case 'call':
                            const callAmount = gameStateData.currentBet - (players[playerId].currentBet || 0);
                            if (callAmount > 0) {
                                updates[`players/${playerId}/chips`] = (players[playerId].chips || 1000) - callAmount;
                                updates[`players/${playerId}/currentBet`] = gameStateData.currentBet;
                                updates[`gameState/pot`] = (gameStateData.pot || 0) + callAmount;
                                addLogEntry(`${players[playerId].name} calls $${callAmount}`);
                            }
                            break;
                            
                        case 'bet':
                        case 'raise':
                            if (betAmount > 0) {
                                updates[`players/${playerId}/chips`] = (players[playerId].chips || 1000) - betAmount;
                                updates[`players/${playerId}/currentBet`] = (players[playerId].currentBet || 0) + betAmount;
                                updates[`gameState/currentBet`] = (players[playerId].currentBet || 0) + betAmount;
                                updates[`gameState/pot`] = (gameStateData.pot || 0) + betAmount;
                                addLogEntry(`${players[playerId].name} ${actionType}s $${betAmount}`);
                            }
                            break;
                    }
                    
                    // Mark player as acted
                    updates[`players/${playerId}/hasActed`] = true;
                    
                    // Move to next player
                    const nextPlayer = getNextPlayer(playerId, players, gameStateData);
                    if (nextPlayer) {
                        updates[`gameState/currentPlayer`] = nextPlayer;
                    } else {
                        // All players have acted, advance to next betting round
                        advanceBettingRound(gameStateData, players);
                    }
                    
                    // Apply updates
                    return database.ref('games/' + gameState.gameId).update(updates);
                })
                .catch(error => {
                    console.error('Error processing action:', error);
                });
        }

        // Get next player who can act
        function getNextPlayer(currentPlayerId, players, gameStateData) {
            const playerIds = Object.keys(players);
            const currentIndex = playerIds.indexOf(currentPlayerId);
            let nextIndex = (currentIndex + 1) % playerIds.length;
            
            // Find next non-folded player who hasn't acted
            let checkedPlayers = 0;
            while (checkedPlayers < playerIds.length) {
                const nextPlayerId = playerIds[nextIndex];
                const nextPlayer = players[nextPlayerId];
                
                if (!nextPlayer.folded && !nextPlayer.hasActed) {
                    return nextPlayerId;
                }
                
                nextIndex = (nextIndex + 1) % playerIds.length;
                checkedPlayers++;
            }
            
            return null; // All players have acted
        }

        // Advance to next betting round or end hand
        function advanceBettingRound(gameStateData, players) {
            let updates = {};
            const playerIds = Object.keys(players);
            
            // Reset players' acted status
            playerIds.forEach(playerId => {
                updates[`players/${playerId}/hasActed`] = false;
                updates[`players/${playerId}/currentBet`] = 0;
            });
            
            // Reset current bet
            updates[`gameState/currentBet`] = 0;
            
            // Determine next betting round
            switch(gameStateData.bettingRound) {
                case 'preflop':
                    // Deal flop
                    const flopCards = gameStateData.deck.splice(0, 3);
                    updates[`gameState/communityCards`] = flopCards;
                    updates[`gameState/bettingRound`] = 'flop';
                    updates[`gameState/deck`] = gameStateData.deck;
                    updates[`gameState/currentPlayer`] = playerIds[0]; // Start with first player
                    addLogEntry("*** FLOP ***");
                    break;
                    
                case 'flop':
                    // Deal turn
                    const turnCard = gameStateData.deck.splice(0, 1)[0];
                    updates[`gameState/communityCards`] = [...gameStateData.communityCards, turnCard];
                    updates[`gameState/bettingRound`] = 'turn';
                    updates[`gameState/deck`] = gameStateData.deck;
                    updates[`gameState/currentPlayer`] = playerIds[0];
                    addLogEntry("*** TURN ***");
                    break;
                    
                case 'turn':
                    // Deal river
                    const riverCard = gameStateData.deck.splice(0, 1)[0];
                    updates[`gameState/communityCards`] = [...gameStateData.communityCards, riverCard];
                    updates[`gameState/bettingRound`] = 'river';
                    updates[`gameState/deck`] = gameStateData.deck;
                    updates[`gameState/currentPlayer`] = playerIds[0];
                    addLogEntry("*** RIVER ***");
                    break;
                    
                case 'river':
                    // Showdown - end hand
                    updates[`gameState/bettingRound`] = 'showdown';
                    updates[`gameState/currentPlayer`] = null;
                    addLogEntry("*** SHOWDOWN ***");
                    // In a real game, you'd evaluate hands here
                    setTimeout(() => startNewHand(createDeck()), 3000);
                    break;
            }
            
            return database.ref('games/' + gameState.gameId).update(updates);
        }

        // Show betting controls
        function showBettingControls() {
            const minBet = this.id === 'raise-btn' ? 20 : 10;
            const maxBet = Math.min(gameState.playerChips, 500);
            
            betSlider.min = minBet;
            betSlider.max = maxBet;
            betSlider.value = Math.max(minBet, Math.min(50, maxBet));
            updateBetAmount();
            bettingControls.style.display = 'flex';
        }

        // Update bet amount display
        function updateBetAmount() {
            betAmountEl.textContent = betSlider.value;
        }

        // Confirm bet
        function confirmBet() {
            const action = betBtn.disabled ? 'raise' : 'bet';
            const betAmount = parseInt(betAmountEl.textContent);
            sendPlayerAction(action, betAmount);
        }

        // Enable player actions
        function enablePlayerActions() {
            checkBtn.disabled = false;
            callBtn.disabled = false;
            betBtn.disabled = false;
            raiseBtn.disabled = false;
            foldBtn.disabled = false;
        }

        // Disable player actions
        function disablePlayerActions() {
            checkBtn.disabled = true;
            callBtn.disabled = true;
            betBtn.disabled = true;
            raiseBtn.disabled = true;
            foldBtn.disabled = true;
        }

        // Send chat message
        function sendChatMessage() {
            const message = chatInputEl.value.trim();
            if (message && gameState.gameId) {
                const chatData = {
                    playerId: gameState.playerId,
                    playerName: gameState.playerName,
                    text: message,
                    timestamp: Date.now()
                };
                
                database.ref('games/' + gameState.gameId + '/chat').push(chatData)
                    .then(() => {
                        chatInputEl.value = '';
                    });
            }
        }

        // Add chat message to display
        function addChatMessage(sender, message, timestamp) {
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            const messageEl = document.createElement('div');
            messageEl.className = 'log-entry';
            messageEl.textContent = `[${time}] ${sender}: ${message}`;
            chatMessagesEl.appendChild(messageEl);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // Add log entry
        function addLogEntry(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logEntriesEl.appendChild(entry);
            logEntriesEl.scrollTop = logEntriesEl.scrollHeight;
        }

        // Copy game ID to clipboard
        function copyGameId() {
            inviteGameIdEl.select();
            document.execCommand('copy');
            alert('Game ID copied to clipboard!');
        }

        // Reset game state
        function resetGame() {
            gameState.gameId = null;
            gameState.isHost = false;
            playersAroundTableEl.innerHTML = '';
            communityCardsEl.innerHTML = '';
            handResultEl.textContent = '';
            logEntriesEl.innerHTML = '<div class="log-entry">Welcome to Firebase Poker!</div>';
            chatMessagesEl.innerHTML = '<div class="log-entry">System: Welcome to the table!</div>';
            disablePlayerActions();
        }

        // Initialize the game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>